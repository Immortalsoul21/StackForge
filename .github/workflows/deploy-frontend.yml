name: Deploy Frontend to ECS

on:
  push:
    branches: [ "main" ]
    paths:
      - "frontend/**"
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::557485611178:role/GitHubECSDeployRole
        aws-region: us-east-1
    - name: Ensure ECS Task Execution Role exists
      run: |
          if ! aws iam get-role --role-name ecsTaskExecutionRole 2>/dev/null; then
            echo "Role doesn't exist, creating it..."
            
            # Create the role
            aws iam create-role \
              --role-name ecsTaskExecutionRole \
              --assume-role-policy-document '{
                "Version": "2012-10-17",
                "Statement": [{
                  "Effect": "Allow",
                  "Principal": {"Service": "ecs-tasks.amazonaws.com"},
                  "Action": "sts:AssumeRole"
                }]
              }'
            
            # Attach the required policy
            aws iam attach-role-policy \
              --role-name ecsTaskExecutionRole \
              --policy-arn arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
            
            echo "Role created successfully"
          else
            echo "Role already exists, skipping creation"
          fi

    - uses: aws-actions/amazon-ecr-login@v2

    - name: Fetch frontend secrets
      run: |
        SECRET_JSON=$(aws secretsmanager get-secret-value \
          --secret-id stackforge-frontend \
          --query SecretString --output text)
        if [ $? -ne 0 ]; then
          echo "Failed to fetch secrets from AWS Secrets Manager"
          exit 1
        fi
        API_URL=$(echo $SECRET_JSON | jq -r '.VITE_API_URL')
        echo "API_URL=$API_URL" >> $GITHUB_ENV

    - name: Build and push Docker image
      id: build
      run: |
        IMAGE_URI=557485611178.dkr.ecr.us-east-1.amazonaws.com/stackforge-frontend:${{ github.sha }}
        docker build \
          --build-arg VITE_API_URL=$API_URL \
          -t $IMAGE_URI frontend
        docker push $IMAGE_URI
        echo "image=$IMAGE_URI" >> $GITHUB_OUTPUT

    - name: Render task definition
      id: task-def
      uses: aws-actions/amazon-ecs-render-task-definition@v1
      with:
        task-definition: frontend/ecs-task-def-frontend.json
        container-name: frontend
        image: ${{ steps.build.outputs.image }}

    - name: Deploy to ECS
      uses: aws-actions/amazon-ecs-deploy-task-definition@v1
      with:
        task-definition: ${{ steps.task-def.outputs.task-definition }}
        service: stackforge-frontend-task-service-gdim1f8a 
        cluster: stackforge-cluster
        wait-for-service-stability: true
